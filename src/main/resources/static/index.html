<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>IM Web Client</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            height: 90vh;
            min-height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            overflow: hidden;
            display: flex;
        }

        #loginPanel {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
            color: white;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #loginPanel h1 {
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #loginPanel input {
            width: 320px;
            padding: 18px;
            border: none;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 16px;
            outline: none;
            background: rgba(255,255,255,0.9);
            transition: all 0.3s ease;
        }

        #loginPanel input:focus {
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        #loginPanel button {
            width: 320px;
            padding: 18px;
            border: none;
            border-radius: 12px;
            background: #00C853;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,200,83,0.3);
        }

        #loginPanel button:hover {
            background: #00E676;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,200,83,0.4);
        }

        #chatPanel {
            display: none;
            height: 100%;
            width: 100%;
            grid-template-columns: 300px 1fr;
        }

        .sidebar {
            min-width: 300px;
            max-width: 350px;
            height: 100%;
            background: #F8F9FB;
            border-right: 1px solid #E8EEF3;
            display: flex;
            flex-direction: column;
        }

        .user-info {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #E8EEF3;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .current-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: white;
            font-weight: 600;
        }

        .user-details h2 {
            font-size: 1.1em;
            color: #2C3E50;
            margin-bottom: 4px;
        }

        .user-status {
            font-size: 0.85em;
            color: #00C853;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-button {
            background: none;
            border: none;
            color: #90A4AE;
            font-size: 1.2em;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .logout-button:hover {
            background: #F5F7FA;
            color: #FF3D00;
        }

        .user-search {
            padding: 15px;
            position: relative;
            border-bottom: 1px solid #E8EEF3;
        }

        .user-search i {
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: #90A4AE;
        }

        .user-search input {
            width: 100%;
            padding: 12px 15px 12px 35px;
            border: 1px solid #E8EEF3;
            border-radius: 20px;
            font-size: 0.9em;
            outline: none;
            transition: all 0.3s ease;
        }

        .user-search input:focus {
            border-color: #2979FF;
            box-shadow: 0 0 0 3px rgba(41, 121, 255, 0.1);
        }

        .user-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .user-item {
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-item:hover {
            background: #F0F2F5;
        }

        .user-item.active {
            background: #E3F2FD;
        }

        .user-item .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
        }

        .user-item .user-info {
            flex: 1;
            padding: 0;
            background: none;
            border: none;
        }

        .user-item .user-name {
            font-weight: 500;
            color: #2C3E50;
            margin-bottom: 2px;
        }

        .user-item .user-status {
            font-size: 0.8em;
        }

        .chat-area {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: white;
            position: relative;
            overflow: hidden;
        }

        #messageArea {
            flex: 1;
            padding: 20px 30px 90px 30px;
            overflow-y: auto;
            background: white;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px 30px;
            border-bottom: 1px solid #E8EEF3;
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header h2 {
            color: #2C3E50;
            font-size: 1.2em;
        }

        .message {
            margin: 15px 0;
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            position: relative;
            animation: messageSlide 0.3s ease;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.received {
            background: #F5F7FA;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .message.sent {
            background: #2979FF;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message .time {
            font-size: 0.75em;
            margin-top: 5px;
            opacity: 0.7;
        }

        .message img {
            max-width: 100%;
            border-radius: 12px;
            margin: 5px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message-status {
            font-size: 0.75em;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
            opacity: 0.8;
        }

        .message-status .status-text {
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .message.received .message-status .status-text {
            color: rgba(0, 0, 0, 0.5);
        }

        .message-status .status-icon {
            transition: color 0.3s ease;
        }

        .message-status .status-icon.read {
            color: #4FC3F7;
        }

        .message.received .message-status {
            justify-content: flex-start;
        }

        .message.received .message-status .status-text {
            color: rgba(0, 0, 0, 0.5);
        }

        .chat-input {
            position: fixed;
            bottom: 0;
            right: 0;
            width: calc(100% - 300px);
            padding: 20px;
            background: white;
            border-top: 1px solid #E8EEF3;
            display: flex;
            gap: 15px;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #E8EEF3;
            border-radius: 20px;
            font-size: 0.95em;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input input:focus {
            border-color: #2979FF;
            box-shadow: 0 0 0 3px rgba(41, 121, 255, 0.1);
        }

        .send-button {
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            background: #2979FF;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-button:hover {
            background: #2962FF;
            transform: translateY(-1px);
        }

        .send-button:disabled {
            background: #E0E0E0;
            cursor: not-allowed;
            transform: none;
        }

        .system-message {
            text-align: center;
            color: #90A4AE;
            font-size: 0.85em;
            margin: 10px 0;
            padding: 5px 10px;
            background: rgba(144, 164, 174, 0.1);
            border-radius: 10px;
            align-self: center;
        }

        .system-message::before,
        .system-message::after {
            content: '';
            height: 1px;
            background: #E8EEF3;
            flex: 1;
        }

        .image-upload-button {
            padding: 12px;
            cursor: pointer;
            color: #2979FF;
            transition: all 0.3s ease;
            border-radius: 50%;
        }

        .image-upload-button:hover {
            background: rgba(41,121,255,0.1);
            color: #2962FF;
        }

        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            color: #90A4AE;
            background: rgba(144,164,174,0.1);
            border-radius: 12px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .loading-history {
            text-align: center;
            padding: 20px;
            color: #90A4AE;
        }

        .error-message {
            text-align: center;
            padding: 20px;
            color: #FF3D00;
        }

        .text-primary {
            color: #4FC3F7;
        }

        /* 添加响应式布局 */
        @media (max-width: 768px) {
            .container {
                height: 100vh;
                border-radius: 0;
            }

            .sidebar {
                min-width: 250px;
            }

            #chatPanel {
                grid-template-columns: 250px 1fr;
            }

            .chat-input {
                width: calc(100% - 250px);
            }
        }

        @media (max-width: 576px) {
            body {
                padding: 0;
            }

            .container {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
            }

            .message {
                max-width: 85%;
            }

            .chat-input {
                padding: 15px;
            }

            .send-button {
                padding: 12px 20px;
            }
        }

        /* 添加下拉刷新相关样式 */
        .refresh-indicator {
            display: none;
            justify-content: center;
            align-items: center;
            padding: 15px;
            color: #90A4AE;
            font-size: 0.9em;
        }

        .refresh-indicator.visible {
            display: flex;
        }

        .refresh-spinner {
            margin-right: 8px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loginPanel">
            <h1>Welcome to Chat</h1>
            <input type="text" id="username" placeholder="Enter your username" onkeypress="handleKeyPress(event)">
            <button onclick="login()">
                <i class="fas fa-sign-in-alt"></i> Join Chat
            </button>
        </div>

        <div id="chatPanel">
            <div class="sidebar">
                <div class="user-info">
                    <div class="current-user">
                        <div class="user-avatar">
                            <span id="currentUserAvatar"></span>
                        </div>
                        <div class="user-details">
                            <h2 id="currentUserName"></h2>
                            <div class="user-status">
                                <i class="fas fa-circle"></i> Online
                            </div>
                        </div>
                    </div>
                    <button class="logout-button" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
                <div class="user-search">
                    <i class="fas fa-search"></i>
                    <input type="text" id="userSearch" placeholder="Search users...">
                </div>
                <div class="user-list" id="userList"></div>
            </div>

            <div class="chat-area">
                <div class="chat-header">
                    <h2>Chat with <span id="chatWith">Select a user</span></h2>
                </div>
                <div id="messageArea"></div>
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="Type your message..." disabled>
                    <button class="send-button" onclick="sendMessage()" disabled>
                        <i class="fas fa-paper-plane"></i>
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let currentUser;
        let selectedUser = null;
        let lastHeartbeatResponse = Date.now();
        
        // 心跳相关常量
        const HEARTBEAT_INTERVAL = 15000;  // 15秒发送一次心跳
        const CONNECTION_TIMEOUT = 45000;   // 45秒没有响应就断开
        let heartbeatTimer = null;
        let connectionCheckTimer = null;

        // 添加下拉刷新相关变量和函数
        let isLoading = false;
        let lastMessageId = null;
        const MESSAGES_PER_PAGE = 20;

        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const baseReconnectDelay = 3000; // 3秒

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function login() {
            const username = document.getElementById('username').value;
            if (!username) {
                alert('Please enter username');
                return;
            }
            
            currentUser = username;
            saveLoginState(username);  // 保存登录状态
            connectWebSocket(username);
        }

        function connectWebSocket(username) {
            // 对用户名进行编码
            const encodedUsername = encodeURIComponent(username);
            ws = new WebSocket(`ws://${window.location.host}/ws?username=${encodedUsername}`);
            
            ws.onopen = function() {
                document.getElementById('loginPanel').style.display = 'none';
                document.getElementById('chatPanel').style.display = 'grid';
                document.getElementById('currentUserName').textContent = username;
                setCurrentUserAvatar(username);
                
                // 发送登录消息
                const loginMessage = {
                    type: 'LOGIN',
                    from: username,
                    timestamp: Date.now()
                };
                ws.send(JSON.stringify(loginMessage));
                
                updateConnectionStatus('connected');
                startHeartbeat();
            };

            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    
                    lastHeartbeatResponse = Date.now();
                    
                    switch(message.type) {
                        case 'CHAT':
                            // 创建新消息元素
                            const messageDiv = document.createElement('div');
                            messageDiv.className = `message ${message.from === currentUser ? 'sent' : 'received'}`;
                            messageDiv.setAttribute('data-message-id', message.messageId);
                            
                            // 创建消息内容
                            const contentDiv = document.createElement('div');
                            contentDiv.className = 'message-content';
                            contentDiv.textContent = message.content;
                            messageDiv.appendChild(contentDiv);
                            
                            // 添加时间
                            const timeDiv = document.createElement('div');
                            timeDiv.className = 'time';
                            timeDiv.textContent = new Date(message.timestamp).toLocaleTimeString();
                            messageDiv.appendChild(timeDiv);
                            
                            // 如果是发送的消息，添加状态
                            if (message.from === currentUser) {
                                const statusDiv = document.createElement('div');
                                statusDiv.className = 'message-status';
                                statusDiv.innerHTML = `
                                    <span class="status-text">已发送</span>
                                    <i class="status-icon fas fa-check"></i>
                                `;
                                messageDiv.appendChild(statusDiv);
                            }
                            
                            const messageArea = document.getElementById('messageArea');
                            messageArea.appendChild(messageDiv);
                            
                            // 检查是否需要滚动
                            if (shouldScrollToBottom(messageArea)) {
                                scrollToBottom(true);
                            }

                            // 如果是接收到的消息，发送已读回执
                            if (message.from !== currentUser) {
                                sendReadReceipt(message);
                                // 发送确认消息
                                const ackMessage = {
                                    type: 'ACK',
                                    ackMessageId: message.messageId,
                                    from: currentUser,
                                    to: message.from,
                                    timestamp: Date.now()
                                };
                                ws.send(JSON.stringify(ackMessage));
                            }
                            break;

                        case 'ACK':
                            // 更新消息状态为已送达
                            updateMessageStatus(message.ackMessageId, 'DELIVERED');
                            break;

                        case 'READ_RECEIPT':
                            // 更新消息状态为已读
                            updateMessageStatus(message.messageId, 'READ');
                            break;

                        case 'LOGIN':
                            if (message.from !== currentUser) {
                                updateUserList(message.from, true);
                                showSystemMessage(`${message.from} has joined`);
                            }
                            break;

                        case 'LOGOUT':
                            updateUserList(message.from, false);
                            showSystemMessage(`${message.from} has left`);
                            if (selectedUser === message.from) {
                                selectedUser = null;
                                document.getElementById('chatWith').textContent = 'Select a user';
                                document.getElementById('messageInput').disabled = true;
                                document.querySelector('.send-button').disabled = true;
                            }
                            break;

                        case 'USER_LIST':
                            // 处理用户列表
                            if (message.users) {
                                message.users.forEach(user => {
                                    if (user !== currentUser) {
                                        updateUserList(user, true);
                                    }
                                });
                            }
                            break;

                        case 'HEARTBEAT':
                            // 收到心跳包，发送响应
                            sendHeartbeatResponse();
                            break;

                        case 'HEARTBEAT_RESPONSE':
                            // 更新最后心跳响应时间
                            lastHeartbeatResponse = Date.now();
                            break;

                        default:
                            console.warn('Unknown message type:', message.type);
                            break;
                    }
                } catch (error) {
                    console.error('Error handling message:', error);
                }
            };

            ws.onclose = function(event) {
                updateConnectionStatus('disconnected');
                
                // 只有在非正常关闭时才尝试重连
                if (event.code !== 1000 && event.code !== 1001) {
                    if (reconnectAttempts < maxReconnectAttempts) {
                        // 使用指数退避策略
                        const delay = baseReconnectDelay * Math.pow(2, reconnectAttempts);
                        setTimeout(() => {
                            if (currentUser) {
                                connectWebSocket(currentUser);
                                reconnectAttempts++;
                            }
                        }, delay);
                    } else {
                        showSystemMessage('Connection lost. Please refresh the page.');
                    }
                } else {
                    // 正常关闭时重置重连计数
                    reconnectAttempts = 0;
                }
            };
        }

        function updateUserList(username, isOnline) {
            if (username === currentUser) return;

            const userList = document.getElementById('userList');
            const existingUser = userList.querySelector(`[data-username="${username}"]`);

            if (isOnline) {
                if (!existingUser) {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'user-item';
                    userDiv.setAttribute('data-username', username);
                    userDiv.innerHTML = `
                        <div class="user-avatar">
                            ${username.charAt(0).toUpperCase()}
                        </div>
                        <div class="user-info">
                            <div class="user-name">${username}</div>
                            <div class="user-status">
                                <i class="fas fa-circle"></i> Online
                            </div>
                        </div>
                    `;
                    userDiv.onclick = () => selectUser(username);
                    userList.appendChild(userDiv);
                }
            } else if (existingUser) {
                userList.removeChild(existingUser);
            }
        }

        function selectUser(username) {
            if (username === currentUser) return;
            
            selectedUser = username;
            document.getElementById('chatWith').textContent = username;
            
            // 更新选中状态
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const selectedDiv = document.querySelector(`[data-username="${username}"]`);
            if (selectedDiv) {
                selectedDiv.classList.add('active');
            }

            // 启用输入框和发送按钮
            document.getElementById('messageInput').disabled = false;
            document.querySelector('.send-button').disabled = false;

            // 重置消息加载状态
            lastMessageId = null;
            isLoading = false;

            // 清空消息区域并加载新的历史消息
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = '';
            loadChatHistory(username);
        }

        async function loadChatHistory(username, beforeId = null) {
            if (isLoading) return;
            isLoading = true;

            const refreshIndicator = addRefreshIndicator();
            refreshIndicator.classList.add('visible');

            try {
                const url = new URL(`/api/chat/history`, window.location.origin);
                url.searchParams.append('user1', currentUser);
                url.searchParams.append('user2', username);
                url.searchParams.append('limit', MESSAGES_PER_PAGE);
                if (beforeId) {
                    url.searchParams.append('beforeId', beforeId);
                }

                const response = await fetch(url);
                const history = await response.json();

                if (history.length > 0) {
                    const messageArea = document.getElementById('messageArea');
                    const oldHeight = messageArea.scrollHeight;
                    const oldScroll = messageArea.scrollTop;

                    history.reverse().forEach(msg => {
                        const messageDiv = createMessageElement(msg);
                        messageArea.insertBefore(messageDiv, refreshIndicator);
                    });

                    if (!beforeId) {
                        // 首次加载时滚动到底部
                        scrollToBottom(false);
                    } else {
                        // 加载更多历史消息时保持位置
                        messageArea.scrollTop = messageArea.scrollHeight - oldHeight + oldScroll;
                    }

                    lastMessageId = history[0].id;
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                showError('Failed to load chat history');
            } finally {
                isLoading = false;
                refreshIndicator.classList.remove('visible');
            }
        }

        // 添加滚动监听
        function initializeScrollListener() {
            const messageArea = document.getElementById('messageArea');
            messageArea.addEventListener('scroll', () => {
                if (messageArea.scrollTop === 0 && !isLoading && lastMessageId) {
                    loadChatHistory(selectedUser, lastMessageId);
                }
            });
        }

        // 创建消息元素的辅助函数
        function createMessageElement(msg) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.fromUser === currentUser ? 'sent' : 'received'}`;
            messageDiv.setAttribute('data-message-id', msg.messageId);
            
            // 使用 textContent 设置消息内容
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = msg.content;
            messageDiv.appendChild(contentDiv);
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'time';
            timeDiv.textContent = new Date(msg.timestamp).toLocaleTimeString();
            messageDiv.appendChild(timeDiv);
            
            if (msg.fromUser === currentUser) {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'message-status';
                statusDiv.innerHTML = `
                    <span class="status-text">${getStatusText(msg.status)}</span>
                    <i class="status-icon fas ${getStatusIcon(msg.status)}" 
                       ${msg.status === 'READ' ? 'style="color: #4FC3F7"' : ''}></i>
                `;
                messageDiv.appendChild(statusDiv);
            }
            
            return messageDiv;
        }

        function getStatusText(status) {
            switch (status?.toUpperCase()) {
                case 'SENDING': return '发送中';
                case 'SENT': return '已发送';
                case 'DELIVERED': return '已送达';
                case 'READ': return '已读';
                default: return '发送中';
            }
        }

        function getStatusIcon(status) {
            switch (status?.toUpperCase()) {
                case 'SENDING': return 'fa-clock';
                case 'SENT': return 'fa-check';
                case 'DELIVERED': return 'fa-check-double';
                case 'READ': return 'fa-check-double';
                default: return 'fa-clock';
            }
        }

        function scrollToBottom(smooth = true) {
            const messageArea = document.getElementById('messageArea');
            const lastMessage = messageArea.lastElementChild;
            if (lastMessage) {
                lastMessage.scrollIntoView({
                    behavior: smooth ? 'smooth' : 'auto',
                    block: 'end'
                });
            }
        }

        function shouldScrollToBottom(messageArea) {
            const threshold = 100; // 滚动阈值
            const distanceFromBottom = messageArea.scrollHeight - (messageArea.scrollTop + messageArea.clientHeight);
            return distanceFromBottom <= threshold;
        }

        function sendMessage() {
            const content = document.getElementById('messageInput').value.trim();
            if (!content) {
                alert('请输入消息内容');
                return;
            }
            
            if (!selectedUser) {
                alert('请选择聊天对象');
                return;
            }

            const messageId = generateMessageId();
            const message = {
                messageId: messageId,
                from: currentUser,
                to: selectedUser,
                content: content,
                type: 'CHAT',
                messageType: 'text',
                needAck: true,
                timestamp: Date.now(),
                status: 'SENDING'
            };

            try {
                // 使用 UTF-8 编码发送消息
                ws.send(new TextEncoder().encode(JSON.stringify(message)));
                document.getElementById('messageInput').value = '';
                
                const messageArea = document.getElementById('messageArea');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message sent';
                messageDiv.setAttribute('data-message-id', messageId);
                
                // 使用 textContent 而不是 innerHTML 来设置内容
                const contentDiv = document.createElement('div');
                contentDiv.textContent = content;
                messageDiv.appendChild(contentDiv);
                
                messageDiv.innerHTML += `
                    <div class="time">${new Date().toLocaleTimeString()}</div>
                    <div class="message-status">
                        <span class="status-text">发送中</span>
                        <i class="status-icon fas fa-clock"></i>
                    </div>
                `;
                
                messageArea.appendChild(messageDiv);
                scrollToBottom(true);

                setTimeout(() => {
                    const statusDiv = messageDiv.querySelector('.message-status');
                    if (statusDiv && statusDiv.querySelector('.status-text').textContent === '发送中') {
                        updateMessageStatus(messageId, 'SENT');
                    }
                }, 2000);
            } catch (error) {
                console.error('Error sending message:', error);
                alert('发送消息失败，请重试');
            }
        }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!selectedUser) {
                alert('Please select a user first');
                return;
            }

            // 创建loading提示
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message sent loading-indicator';
            loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            document.getElementById('messageArea').appendChild(loadingDiv);
            loadingDiv.scrollIntoView({ behavior: 'smooth' });

            try {
                // 将图片转换为Base64
                const base64Image = await convertToBase64(file);
                
                const message = {
                    from: currentUser,
                    to: selectedUser,
                    content: base64Image,
                    type: 'CHAT',
                    messageType: 'image',
                    needAck: true,
                    timestamp: Date.now()
                };

                ws.send(JSON.stringify(message));
                
                // 移除loading提示
                loadingDiv.remove();
                
                // 添加图片消息到聊天区域
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message sent';
                messageDiv.innerHTML = `
                    <img src="${base64Image}" alt="sent image">
                    <div class="time">${new Date().toLocaleTimeString()}</div>
                `;
                document.getElementById('messageArea').appendChild(messageDiv);
                messageDiv.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error uploading image:', error);
                loadingDiv.remove();
                alert('Failed to upload image');
            }

            // 清除文件输入
            event.target.value = '';
        }

        function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function updateMessageStatus(messageId, status) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageDiv) return;

            const statusDiv = messageDiv.querySelector('.message-status');
            if (!statusDiv) return;

            const statusText = getStatusText(status);
            const statusIcon = getStatusIcon(status);
            const statusColor = status?.toUpperCase() === 'READ' ? '#4FC3F7' : '';

            statusDiv.innerHTML = `
                <span class="status-text">${statusText}</span>
                <i class="status-icon fas ${statusIcon}" ${statusColor ? `style="color: ${statusColor}"` : ''}></i>
            `;
        }

        function sendReadReceipt(message) {
            if (!message.messageId) return;
            
            const readReceipt = {
                type: 'READ_RECEIPT',
                messageId: message.messageId,
                from: currentUser,
                to: message.from,
                timestamp: Date.now()
            };
            
            try {
                ws.send(JSON.stringify(readReceipt));
            } catch (error) {
                console.error('Error sending read receipt:', error);
            }
        }

        function generateMessageId() {
            return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // 心跳相关函数
        function startHeartbeat() {
            // 清除可能存在的旧定时器
            stopHeartbeat();
            
            // 启动新的心跳定时器
            heartbeatTimer = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    sendHeartbeat();
                }
            }, HEARTBEAT_INTERVAL);

            // 启动连接检查定时器
            connectionCheckTimer = setInterval(() => {
                if (Date.now() - lastHeartbeatResponse > CONNECTION_TIMEOUT) {
                    console.log('Connection timeout, reconnecting...');
                    ws.close();  // 这将触发 onclose 事件，从而启动重连
                }
            }, HEARTBEAT_INTERVAL);
        }

        function stopHeartbeat() {
            if (heartbeatTimer) {
                clearInterval(heartbeatTimer);
                heartbeatTimer = null;
            }
            if (connectionCheckTimer) {
                clearInterval(connectionCheckTimer);
                connectionCheckTimer = null;
            }
        }

        function sendHeartbeat() {
            const heartbeat = {
                type: 'HEARTBEAT',
                from: currentUser,
                timestamp: Date.now()
            };
            ws.send(JSON.stringify(heartbeat));
        }

        function sendHeartbeatResponse() {
            const response = {
                type: 'HEARTBEAT_RESPONSE',
                from: currentUser,
                timestamp: Date.now()
            };
            ws.send(JSON.stringify(response));
        }

        // 添加消息队列管理
        const messageQueue = {
            messages: new Map(),
            add: function(message) {
                this.messages.set(message.messageId, message);
                if (this.messages.size >= 10) { // 达到批量大小
                    this.sendBatchAck();
                }
            },
            sendBatchAck: function() {
                if (this.messages.size === 0) return;

                const messageIds = Array.from(this.messages.keys());
                const batchAckMessage = {
                    type: 'BATCH_ACK',
                    batchAckMessageIds: messageIds,
                    timestamp: Date.now()
                };

                ws.send(JSON.stringify(batchAckMessage));
                this.messages.clear();
            }
        };

        // 定时发送批量确认
        setInterval(() => {
            messageQueue.sendBatchAck();
        }, 5000); // 5秒检查一次

        // 添加连接状态提示
        function updateConnectionStatus(status) {
            const statusDiv = document.querySelector('.user-status');
            if (statusDiv) {
                switch(status) {
                    case 'connected':
                        statusDiv.innerHTML = '<i class="fas fa-circle"></i> Online';
                        statusDiv.style.color = '#00C853';
                        break;
                    case 'disconnected':
                        statusDiv.innerHTML = '<i class="fas fa-circle"></i> Offline';
                        statusDiv.style.color = '#FF3D00';
                        break;
                    case 'connecting':
                        statusDiv.innerHTML = '<i class="fas fa-circle"></i> Connecting...';
                        statusDiv.style.color = '#FFC107';
                        break;
                }
            }
        }

        // 添加回车发送功能
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 添加登录状态管理
        function saveLoginState(username) {
            localStorage.setItem('currentUser', username);
        }

        function loadLoginState() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                connectWebSocket(savedUser);
                return true;
            }
            return false;
        }

        function clearLoginState() {
            localStorage.removeItem('currentUser');
        }

        // 修改页面加载逻辑
        window.onload = function() {
            if (!loadLoginState()) {
                document.getElementById('loginPanel').style.display = 'flex';
                document.getElementById('chatPanel').style.display = 'none';
            }
        };

        // 添加注销函数
        function logout() {
            if (ws) {
                const logoutMessage = {
                    type: 'LOGOUT',
                    from: currentUser,
                    timestamp: Date.now()
                };
                ws.send(JSON.stringify(logoutMessage));
                ws.close();
            }
            clearLoginState();
            location.reload();
        }

        document.getElementById('userSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const userItems = document.querySelectorAll('.user-item');
            
            userItems.forEach(item => {
                const userName = item.querySelector('.user-name').textContent.toLowerCase();
                if (userName.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // 设置当前用户头像
        function setCurrentUserAvatar(username) {
            document.getElementById('currentUserAvatar').textContent = username.charAt(0).toUpperCase();
        }

        // 添加系统消息显示函数
        function showSystemMessage(text) {
            const messageArea = document.getElementById('messageArea');
            // 检查是否已经存在相同的系统消息
            const existingMessages = messageArea.querySelectorAll('.system-message');
            for (let msg of existingMessages) {
                if (msg.textContent === text) {
                    // 如果已经存在相同的消息，不重复显示
                    return;
                }
            }
            
            const systemDiv = document.createElement('div');
            systemDiv.className = 'system-message';
            systemDiv.textContent = text;
            messageArea.appendChild(systemDiv);
            
            // 5秒后自动移除系统消息
            setTimeout(() => {
                systemDiv.remove();
            }, 5000);
        }

        // 添加下拉刷新指示器到消息区域顶部
        function addRefreshIndicator() {
            const messageArea = document.getElementById('messageArea');
            const refreshDiv = document.createElement('div');
            refreshDiv.className = 'refresh-indicator';
            refreshDiv.innerHTML = `
                <i class="fas fa-spinner refresh-spinner"></i>
                <span>Loading messages...</span>
            `;
            messageArea.insertBefore(refreshDiv, messageArea.firstChild);
            return refreshDiv;
        }

        // 在页面加载完成后初始化滚动监听
        window.addEventListener('load', () => {
            initializeScrollListener();
        });
    </script>
</body>
</html> 